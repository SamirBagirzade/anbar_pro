{% extends "base.html" %}
{% load i18n %}
{% block content %}
<h4 class="mb-3">{% trans "New Issue" %}</h4>
<form method="post" enctype="multipart/form-data" id="issue-form">
  {% csrf_token %}
  <div class="card mb-3">
    <div class="card-body">
      {{ header_form.as_p }}
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-body p-0">
      <div class="p-3">
        <h6>{% trans "Lines" %}</h6>
      </div>
      {{ formset.management_form }}
      <table class="table table-dense mb-0">
    <thead><tr><th>{% trans "Item" %}</th><th>{% trans "Unit" %}</th><th>{% trans "Qty" %}</th></tr></thead>
    <tbody>
      {% for form in formset %}
        <tr>
          <td>
            <div class="position-relative">
              <input type="text" class="form-control form-control-sm item-search" placeholder="{% trans 'Search item' %}"
                     hx-get="{% url 'item_search' %}" hx-trigger="keyup changed delay:300ms"
                     hx-target="#item-results-{{ forloop.counter0 }}" name="q" autocomplete="off"
                     data-select-id="{{ form.item.id_for_label }}">
              <div id="item-results-{{ forloop.counter0 }}" class="position-absolute w-100" style="z-index: 10;"></div>
            </div>
            <div class="d-none">
              {{ form.item }}
            </div>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm issue-unit" readonly tabindex="-1">
          </td>
          <td>{{ form.qty }}</td>
        </tr>
      {% endfor %}
    </tbody>
      </table>
    </div>
  </div>
  <div class="mb-3">
    <button class="btn btn-outline-secondary btn-sm" type="button" id="add-line">{% trans "Add Line" %}</button>
  </div>
  <div class="card mb-3">
    <div class="card-body">
      <label class="form-label">{% trans "Attachments" %}</label>
      <input class="form-control" type="file" name="attachments" multiple />
    </div>
  </div>
  <button class="btn btn-primary" type="submit">{% trans "Save & Post" %}</button>
</form>

<template id="empty-form-template">
  <tr>
    <td>
      <div class="position-relative">
        <input type="text" class="form-control form-control-sm item-search" placeholder="{% trans 'Search item' %}"
               hx-get="{% url 'item_search' %}" hx-trigger="keyup changed delay:300ms"
               hx-target="#item-results-__prefix__" name="q" autocomplete="off"
               data-select-id="id_{{ formset.prefix }}-__prefix__-item">
        <div id="item-results-__prefix__" class="position-absolute w-100" style="z-index: 10;"></div>
      </div>
      <div class="d-none">
        {{ formset.empty_form.item }}
      </div>
    </td>
    <td>
      <input type="text" class="form-control form-control-sm issue-unit" readonly tabindex="-1">
    </td>
    <td>{{ formset.empty_form.qty }}</td>
  </tr>
</template>

<script>
  (function() {
    window.selectItem = function(itemId, itemName, itemUnit, el) {
      var container = el.closest('td');
      var input = container.querySelector('.item-search');
      var selectId = input.getAttribute('data-select-id');
      var select = document.getElementById(selectId);
      if (select) {
        select.value = itemId;
      }
      input.value = itemName;
      var row = container.closest('tr');
      if (row) {
        var unitInput = row.querySelector('.issue-unit');
        if (unitInput) unitInput.value = itemUnit || '';
      }
      var results = container.querySelector('[id^="item-results-"]');
      if (results) results.innerHTML = '';
    };

    function hydrateSelected() {
      document.querySelectorAll('.item-search').forEach(function(input) {
        var selectId = input.getAttribute('data-select-id');
        var select = document.getElementById(selectId);
        if (select && select.value) {
          var opt = select.options[select.selectedIndex];
          if (opt) input.value = opt.text;
        }
      });
    }
    hydrateSelected();

    var addBtn = document.getElementById('add-line');
    var totalForms = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
    var tbody = document.querySelector('table tbody');
    var template = document.getElementById('empty-form-template').innerHTML;

    addBtn.addEventListener('click', function() {
      var index = parseInt(totalForms.value, 10);
      var html = template.replace(/__prefix__/g, index);
      var temp = document.createElement('tbody');
      temp.innerHTML = html.trim();
      var row = temp.firstChild;
      tbody.appendChild(row);
      totalForms.value = index + 1;
      hydrateSelected();
    });

    var form = document.getElementById('issue-form');
    if (form) {
      form.addEventListener('submit', function(ev) {
        var errors = [];

        var warehouseInput = document.getElementById('{{ header_form.warehouse.id_for_label }}');
        if (warehouseInput && !warehouseInput.value) {
          errors.push('Anbar seçilməlidir.');
        }

        var locationInput = document.getElementById('{{ header_form.outgoing_location.id_for_label }}');
        if (locationInput && !locationInput.value) {
          errors.push('Çıxış yeri seçilməlidir.');
        }

        var issueDateInput = document.getElementById('{{ header_form.issue_date.id_for_label }}');
        if (issueDateInput && !issueDateInput.value.trim()) {
          errors.push('Issue Date doldurulmalıdır.');
        }

        var hasValidLine = false;
        document.querySelectorAll('table tbody tr').forEach(function(row) {
          var itemSearch = row.querySelector('.item-search');
          var qtyInput = row.querySelector('input[name$="-qty"]');
          var itemSelect = null;
          if (itemSearch) {
            itemSelect = document.getElementById(itemSearch.getAttribute('data-select-id'));
          }

          var itemText = itemSearch ? itemSearch.value.trim() : '';
          var itemVal = itemSelect ? itemSelect.value : '';
          var qtyVal = qtyInput ? qtyInput.value.trim() : '';
          var started = !!(itemText || qtyVal);
          if (!started) return;

          if (!itemText && !itemVal) {
            errors.push('Sətirdə məhsul seçilməlidir.');
          }
          if (!qtyVal) {
            errors.push('Sətirdə miqdar doldurulmalıdır.');
          }
          if ((itemText || itemVal) && qtyVal) {
            hasValidLine = true;
          }
        });

        if (!hasValidLine) {
          errors.push('Ən azı bir məhsul sətri doldurulmalıdır.');
        }

        if (errors.length) {
          ev.preventDefault();
          alert(errors.join('\n'));
        }
      });
    }
  })();
</script>
{% endblock %}
