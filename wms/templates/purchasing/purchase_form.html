{% extends "base.html" %}
{% load i18n %}
{% block content %}
<h4 class="mb-3">{% if title %}{{ title }}{% else %}{% trans "New Purchase" %}{% endif %}</h4>
<form method="post" enctype="multipart/form-data" id="purchase-form">
  {% csrf_token %}
  {% if header_form.non_field_errors %}
    <div class="alert alert-danger">{{ header_form.non_field_errors }}</div>
  {% endif %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="mb-3 position-relative">
        <label class="form-label" for="vendor-search">{% trans "Vendor" %}</label>
        <input
          type="text"
          id="vendor-search"
          name="q"
          class="form-control"
          placeholder="Təchizatçı axtar"
          hx-get="{% url 'vendor_search' %}"
          hx-trigger="keyup changed delay:300ms"
          hx-target="#vendor-results"
          autocomplete="off"
          data-select-id="{{ header_form.vendor.id_for_label }}"
        >
        <div id="vendor-results" class="position-absolute w-100" style="z-index: 10;"></div>
        <div class="d-none">{{ header_form.vendor }}</div>
        {% for error in header_form.vendor.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label" for="{{ header_form.warehouse.id_for_label }}">{{ header_form.warehouse.label }}</label>
        {{ header_form.warehouse }}
        {% for error in header_form.warehouse.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label" for="{{ header_form.invoice_date.id_for_label }}">{{ header_form.invoice_date.label }}</label>
        {{ header_form.invoice_date }}
        {% for error in header_form.invoice_date.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label" for="{{ header_form.currency.id_for_label }}">{{ header_form.currency.label }}</label>
        {{ header_form.currency }}
        {% for error in header_form.currency.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-0">
        <label class="form-label" for="{{ header_form.notes.id_for_label }}">{{ header_form.notes.label }}</label>
        {{ header_form.notes }}
        {% for error in header_form.notes.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-body p-0">
      <div class="p-3">
        <h6>{% trans "Lines" %}</h6>
        {% if formset.non_form_errors %}
          <div class="text-danger small mt-2">{{ formset.non_form_errors }}</div>
        {% endif %}
      </div>
      {{ formset.management_form }}
      <table class="table table-dense mb-0">
    <thead><tr><th>{% trans "Item" %}</th><th>{% trans "Unit" %}</th><th>{% trans "Qty" %}</th><th>{% trans "Unit Price" %}</th><th>{% trans "Delete" %}</th></tr></thead>
    <tbody>
      {% for form in formset %}
        <tr>
          <td>
            {% if form.non_field_errors %}
              <div class="text-danger small">{{ form.non_field_errors }}</div>
            {% endif %}
            <div class="position-relative">
              <input type="text" class="form-control form-control-sm item-search" placeholder="{% trans 'Search item' %}"
                     hx-get="{% url 'item_search' %}" hx-trigger="keyup changed delay:300ms"
                     hx-target="#item-results-{{ forloop.counter0 }}" name="{{ form.item_name.html_name }}"
                     id="{{ form.item_name.id_for_label }}" value="{{ form.item_name.value|default_if_none:'' }}"
                     autocomplete="off" data-select-id="{{ form.item.id_for_label }}"
                     data-unit-id="{{ form.unit.id_for_label }}">
              <div id="item-results-{{ forloop.counter0 }}" class="position-absolute w-100" style="z-index: 10;"></div>
            </div>
            <div class="d-none">
              {{ form.id }}
              {{ form.item }}
            </div>
          </td>
          <td>
            {{ form.unit }}
            {% for error in form.unit.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          </td>
          <td>{{ form.qty }}</td>
          <td>{{ form.unit_price }}</td>
          <td class="text-center">
            <div class="d-none">{{ form.DELETE }}</div>
            <button type="button" class="btn btn-sm btn-outline-danger row-delete-btn">{% trans "Delete" %}</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
      </table>
    </div>
  </div>
  <div class="mb-3">
    <button class="btn btn-outline-secondary btn-sm" type="button" id="add-line">{% trans "Add Line" %}</button>
  </div>
  <div class="card mb-3">
    <div class="card-body">
      <label class="form-label">{% trans "Attachments" %}</label>
      <input class="form-control" type="file" name="attachments" multiple />
    </div>
  </div>
  <button class="btn btn-primary" type="submit">{% if submit_label %}{{ submit_label }}{% else %}{% trans "Save & Post" %}{% endif %}</button>
</form>

<template id="empty-form-template">
  <tr>
    <td>
      <div class="position-relative">
        <input type="text" class="form-control form-control-sm item-search" placeholder="{% trans 'Search item' %}"
               hx-get="{% url 'item_search' %}" hx-trigger="keyup changed delay:300ms"
               hx-target="#item-results-__prefix__" name="{{ formset.empty_form.item_name.html_name }}"
               id="{{ formset.empty_form.item_name.id_for_label }}" value="{{ formset.empty_form.item_name.value|default_if_none:'' }}"
               autocomplete="off" data-select-id="id_{{ formset.prefix }}-__prefix__-item"
               data-unit-id="id_{{ formset.prefix }}-__prefix__-unit">
        <div id="item-results-__prefix__" class="position-absolute w-100" style="z-index: 10;"></div>
      </div>
      <div class="d-none">
        {{ formset.empty_form.id }}
        {{ formset.empty_form.item }}
        {{ formset.empty_form.DELETE }}
      </div>
    </td>
    <td>
      {{ formset.empty_form.unit }}
    </td>
    <td>{{ formset.empty_form.qty }}</td>
    <td>{{ formset.empty_form.unit_price }}</td>
    <td class="text-center">
      <button type="button" class="btn btn-sm btn-outline-danger row-delete-btn">{% trans "Delete" %}</button>
    </td>
  </tr>
</template>

<script>
  (function() {
    window.selectVendor = function(vendorId, vendorName, el) {
      var container = el.closest('.mb-3');
      var input = container.querySelector('input[type="text"]');
      var selectId = input.getAttribute('data-select-id');
      var select = document.getElementById(selectId);
      if (select) {
        select.value = vendorId;
      }
      input.value = vendorName;
      var results = document.getElementById('vendor-results');
      if (results) results.innerHTML = '';
    };

    window.selectItem = function(itemId, itemName, itemUnit, el) {
      var container = el.closest('td');
      var input = container.querySelector('.item-search');
      var selectId = input.getAttribute('data-select-id');
      var select = document.getElementById(selectId);
      if (select) {
        select.value = itemId;
      }
      input.value = itemName;
      var unitId = input.getAttribute('data-unit-id');
      if (unitId) {
        var unitInput = document.getElementById(unitId);
        if (unitInput && itemUnit) unitInput.value = itemUnit;
      }
      var results = container.querySelector('[id^="item-results-"]');
      if (results) results.innerHTML = '';
    };

    function hydrateSelected() {
      document.querySelectorAll('.item-search').forEach(function(input) {
        var selectId = input.getAttribute('data-select-id');
        var select = document.getElementById(selectId);
        if (select && select.value) {
          var opt = select.options[select.selectedIndex];
          if (opt) input.value = opt.text;
        }
      });

      var vendorSearch = document.getElementById('vendor-search');
      if (vendorSearch) {
        var vendorSelectId = vendorSearch.getAttribute('data-select-id');
        var vendorSelect = document.getElementById(vendorSelectId);
        if (vendorSelect && vendorSelect.value) {
          var vendorOpt = vendorSelect.options[vendorSelect.selectedIndex];
          if (vendorOpt) vendorSearch.value = vendorOpt.text;
        }
      }
    }
    hydrateSelected();

    function bindDeleteButtons(scope) {
      (scope || document).querySelectorAll('.row-delete-btn').forEach(function(btn) {
        if (btn.dataset.bound === '1') return;
        btn.dataset.bound = '1';
        btn.addEventListener('click', function() {
          var row = btn.closest('tr');
          if (!row) return;
          var del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
          if (del) {
            del.checked = true;
          }
          row.style.display = 'none';
        });
      });
    }
    bindDeleteButtons(document);

    var addBtn = document.getElementById('add-line');
    var totalForms = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
    var tbody = document.querySelector('table tbody');
    var template = document.getElementById('empty-form-template').innerHTML;

    addBtn.addEventListener('click', function() {
      var index = parseInt(totalForms.value, 10);
      var html = template.replace(/__prefix__/g, index);
      var temp = document.createElement('tbody');
      temp.innerHTML = html.trim();
      var row = temp.firstChild;
      tbody.appendChild(row);
      if (window.htmx) {
        window.htmx.process(row);
      }
      totalForms.value = index + 1;
      hydrateSelected();
      bindDeleteButtons(row);
    });

    document.addEventListener('click', function(ev) {
      if (ev.target.closest('.item-search, #vendor-search, .list-group-item')) return;
      document.querySelectorAll('[id^="item-results-"], #vendor-results').forEach(function(el) {
        el.innerHTML = '';
      });
    });

    var form = document.getElementById('purchase-form');
    if (form) {
      form.addEventListener('submit', function(ev) {
        var errors = [];

        var vendorSearch = document.getElementById('vendor-search');
        var vendorSelect = null;
        if (vendorSearch) {
          vendorSelect = document.getElementById(vendorSearch.getAttribute('data-select-id'));
        }
        if (!vendorSelect || !vendorSelect.value) {
          errors.push('Təchizatçı seçilməlidir.');
        }

        var warehouseInput = document.getElementById('{{ header_form.warehouse.id_for_label }}');
        if (warehouseInput && !warehouseInput.value) {
          errors.push('Anbar seçilməlidir.');
        }

        var invoiceDateInput = document.getElementById('{{ header_form.invoice_date.id_for_label }}');
        if (invoiceDateInput && !invoiceDateInput.value.trim()) {
          errors.push('Invoice Date doldurulmalıdır.');
        }

        var hasValidLine = false;
        document.querySelectorAll('table tbody tr').forEach(function(row) {
          var deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
          if (deleteInput && deleteInput.checked) return;

          var itemSearch = row.querySelector('.item-search');
          var qtyInput = row.querySelector('input[name$="-qty"]');
          var itemSelect = null;
          if (itemSearch) {
            itemSelect = document.getElementById(itemSearch.getAttribute('data-select-id'));
          }

          var itemText = itemSearch ? itemSearch.value.trim() : '';
          var itemVal = itemSelect ? itemSelect.value : '';
          var qtyVal = qtyInput ? qtyInput.value.trim() : '';
          var started = !!(itemText || qtyVal);
          if (!started) return;

          if (!itemText && !itemVal) {
            errors.push('Sətirdə məhsul seçilməlidir.');
          }
          if (!qtyVal) {
            errors.push('Sətirdə miqdar doldurulmalıdır.');
          }
          if ((itemText || itemVal) && qtyVal) {
            hasValidLine = true;
          }
        });

        if (!hasValidLine) {
          errors.push('Ən azı bir məhsul sətri doldurulmalıdır.');
        }

        if (errors.length) {
          ev.preventDefault();
          alert(errors.join('\n'));
        }
      });
    }
  })();
</script>
{% endblock %}
