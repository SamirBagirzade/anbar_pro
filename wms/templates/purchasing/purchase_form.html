{% extends "base.html" %}
{% load i18n %}
{% block content %}
<h4 class="mb-3">{% trans "New Purchase" %}</h4>
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {% if header_form.non_field_errors %}
    <div class="alert alert-danger">{{ header_form.non_field_errors }}</div>
  {% endif %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="mb-3 position-relative">
        <label class="form-label" for="vendor-search">{% trans "Vendor" %}</label>
        <input
          type="text"
          id="vendor-search"
          name="q"
          class="form-control"
          placeholder="Təchizatçı axtar"
          hx-get="{% url 'vendor_search' %}"
          hx-trigger="keyup changed delay:300ms"
          hx-target="#vendor-results"
          autocomplete="off"
          data-select-id="{{ header_form.vendor.id_for_label }}"
        >
        <div id="vendor-results" class="position-absolute w-100" style="z-index: 10;"></div>
        <div class="d-none">{{ header_form.vendor }}</div>
        {% for error in header_form.vendor.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label" for="{{ header_form.warehouse.id_for_label }}">{{ header_form.warehouse.label }}</label>
        {{ header_form.warehouse }}
        {% for error in header_form.warehouse.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label" for="{{ header_form.invoice_date.id_for_label }}">{{ header_form.invoice_date.label }}</label>
        {{ header_form.invoice_date }}
        {% for error in header_form.invoice_date.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-3">
        <label class="form-label" for="{{ header_form.currency.id_for_label }}">{{ header_form.currency.label }}</label>
        {{ header_form.currency }}
        {% for error in header_form.currency.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
      <div class="mb-0">
        <label class="form-label" for="{{ header_form.notes.id_for_label }}">{{ header_form.notes.label }}</label>
        {{ header_form.notes }}
        {% for error in header_form.notes.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
      </div>
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-body p-0">
      <div class="p-3">
        <h6>{% trans "Lines" %}</h6>
      </div>
      {{ formset.management_form }}
      <table class="table table-dense mb-0">
    <thead><tr><th>{% trans "Item" %}</th><th>{% trans "Unit" %}</th><th>{% trans "Qty" %}</th><th>{% trans "Unit Price" %}</th></tr></thead>
    <tbody>
      {% for form in formset %}
        <tr>
          <td>
            <div class="position-relative">
              <input type="text" class="form-control form-control-sm item-search" placeholder="{% trans 'Search item' %}"
                     hx-get="{% url 'item_search' %}" hx-trigger="keyup changed delay:300ms"
                     hx-target="#item-results-{{ forloop.counter0 }}" name="{{ form.item_name.html_name }}"
                     id="{{ form.item_name.id_for_label }}" value="{{ form.item_name.value|default_if_none:'' }}"
                     autocomplete="off" data-select-id="{{ form.item.id_for_label }}"
                     data-unit-id="{{ form.unit.id_for_label }}">
              <div id="item-results-{{ forloop.counter0 }}" class="position-absolute w-100" style="z-index: 10;"></div>
            </div>
            <div class="d-none">
              {{ form.item }}
            </div>
          </td>
          <td>
            {{ form.unit }}
            {% for error in form.unit.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          </td>
          <td>{{ form.qty }}</td>
          <td>{{ form.unit_price }}</td>
        </tr>
      {% endfor %}
    </tbody>
      </table>
    </div>
  </div>
  <div class="mb-3">
    <button class="btn btn-outline-secondary btn-sm" type="button" id="add-line">{% trans "Add Line" %}</button>
  </div>
  <div class="card mb-3">
    <div class="card-body">
      <label class="form-label">{% trans "Attachments" %}</label>
      <input class="form-control" type="file" name="attachments" multiple />
    </div>
  </div>
  <button class="btn btn-primary" type="submit">{% trans "Save & Post" %}</button>
</form>

<template id="empty-form-template">
  <tr>
    <td>
      <div class="position-relative">
        <input type="text" class="form-control form-control-sm item-search" placeholder="{% trans 'Search item' %}"
               hx-get="{% url 'item_search' %}" hx-trigger="keyup changed delay:300ms"
               hx-target="#item-results-__prefix__" name="{{ formset.empty_form.item_name.html_name }}"
               id="{{ formset.empty_form.item_name.id_for_label }}" value="{{ formset.empty_form.item_name.value|default_if_none:'' }}"
               autocomplete="off" data-select-id="id_{{ formset.prefix }}-__prefix__-item"
               data-unit-id="id_{{ formset.prefix }}-__prefix__-unit">
        <div id="item-results-__prefix__" class="position-absolute w-100" style="z-index: 10;"></div>
      </div>
      <div class="d-none">
        {{ formset.empty_form.item }}
      </div>
    </td>
    <td>
      {{ formset.empty_form.unit }}
    </td>
    <td>{{ formset.empty_form.qty }}</td>
    <td>{{ formset.empty_form.unit_price }}</td>
  </tr>
</template>

<script>
  (function() {
    window.selectVendor = function(vendorId, vendorName, el) {
      var container = el.closest('.mb-3');
      var input = container.querySelector('input[type="text"]');
      var selectId = input.getAttribute('data-select-id');
      var select = document.getElementById(selectId);
      if (select) {
        select.value = vendorId;
      }
      input.value = vendorName;
      var results = document.getElementById('vendor-results');
      if (results) results.innerHTML = '';
    };

    window.selectItem = function(itemId, itemName, itemUnit, el) {
      var container = el.closest('td');
      var input = container.querySelector('.item-search');
      var selectId = input.getAttribute('data-select-id');
      var select = document.getElementById(selectId);
      if (select) {
        select.value = itemId;
      }
      input.value = itemName;
      var unitId = input.getAttribute('data-unit-id');
      if (unitId) {
        var unitInput = document.getElementById(unitId);
        if (unitInput && itemUnit) unitInput.value = itemUnit;
      }
      var results = container.querySelector('[id^="item-results-"]');
      if (results) results.innerHTML = '';
    };

    function hydrateSelected() {
      document.querySelectorAll('.item-search').forEach(function(input) {
        var selectId = input.getAttribute('data-select-id');
        var select = document.getElementById(selectId);
        if (select && select.value) {
          var opt = select.options[select.selectedIndex];
          if (opt) input.value = opt.text;
        }
      });

      var vendorSearch = document.getElementById('vendor-search');
      if (vendorSearch) {
        var vendorSelectId = vendorSearch.getAttribute('data-select-id');
        var vendorSelect = document.getElementById(vendorSelectId);
        if (vendorSelect && vendorSelect.value) {
          var vendorOpt = vendorSelect.options[vendorSelect.selectedIndex];
          if (vendorOpt) vendorSearch.value = vendorOpt.text;
        }
      }
    }
    hydrateSelected();

    var addBtn = document.getElementById('add-line');
    var totalForms = document.getElementById('id_{{ formset.prefix }}-TOTAL_FORMS');
    var tbody = document.querySelector('table tbody');
    var template = document.getElementById('empty-form-template').innerHTML;

    addBtn.addEventListener('click', function() {
      var index = parseInt(totalForms.value, 10);
      var html = template.replace(/__prefix__/g, index);
      var temp = document.createElement('tbody');
      temp.innerHTML = html.trim();
      var row = temp.firstChild;
      tbody.appendChild(row);
      totalForms.value = index + 1;
      hydrateSelected();
    });

    document.addEventListener('click', function(ev) {
      if (ev.target.closest('.item-search, #vendor-search, .list-group-item')) return;
      document.querySelectorAll('[id^="item-results-"], #vendor-results').forEach(function(el) {
        el.innerHTML = '';
      });
    });
  })();
</script>
{% endblock %}
